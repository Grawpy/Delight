<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'floating': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; 
        }
        
        .story-text { line-height: 2.0; }
        
        .clickable-word {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 1px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        .clickable-word:hover { color: #0d9488; background-color: #f0fdfa; }
        .active-word-highlight {
            background-color: #ccfbf1;
            color: #0f766e;
            border-radius: 4px;
            padding: 2px 1px;
            box-shadow: 0 0 0 1px #0d9488;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .perspective-container { perspective: 1500px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
            will-change: transform;
            touch-action: none;
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1.5rem; 
            background-color: white;
            transform: rotateX(0deg); 
            overflow: hidden; 
        }
        .flip-card-back { transform: rotateY(180deg); }
        .flipped { transform: rotateY(180deg); }

        .slide-out-left {
            transition: transform 0.4s ease-in, opacity 0.4s ease-in;
            transform: translateX(-150%) rotate(-20deg) !important;
            opacity: 0;
        }
        .slide-in {
            animation: slide-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slide-in {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        
        @keyframes bounce-sm {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-sm { animation: bounce-sm 2s infinite; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #0d9488;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0d9488;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0d9488;
        }

        /* Custom Scroll for Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 1fr);
            grid-auto-flow: column;
            gap: 4px;
        }
    </style>
</head>
<body class="h-[100dvh] w-full flex justify-center items-center bg-gray-100 font-sans text-gray-800">

    <div id="app" class="w-full max-w-md h-[100dvh] bg-white shadow-2xl overflow-hidden flex flex-col relative">
        
        <!-- Top Bar -->
        <header id="top-bar" class="bg-white px-5 py-3 flex justify-between items-center z-20 sticky top-0 h-16 shadow-[0_2px_10px_rgba(0,0,0,0.03)] transition-transform duration-300">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-brand-400 to-brand-600 rounded-lg flex items-center justify-center text-white shadow-sm shadow-brand-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M9 4.5a.75.75 0 01.721.544l.813 2.846a3.75 3.75 0 002.576 2.576l2.846.813a.75.75 0 010 1.442l-2.846.813a3.75 3.75 0 00-2.576 2.576l-.813 2.846a.75.75 0 01-1.442 0l-.813-2.846a3.75 3.75 0 00-2.576-2.576l-2.846-.813a.75.75 0 010-1.442l2.846-.813a3.75 3.75 0 002.576-2.576l.813-2.846A.75.75 0 019 4.5zM18 1.5a.75.75 0 01.728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 010 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 01-1.456 0l-.258-1.036a2.625 2.625 0 00-1.91-1.91l-1.036-.258a.75.75 0 010-1.456l1.036-.258a2.625 2.625 0 001.91-1.91l.258-1.036A.75.75 0 0118 1.5zM16.5 15a.75.75 0 01.712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 010 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 01-1.422 0l-.395-1.183a1.5 1.5 0 00-.948-.948l-1.183-.395a.75.75 0 010-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0116.5 15z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">Delight</h1>
            </div>
            
            <!-- Updated Profile Area -->
            <div class="flex items-center gap-3">
                <button onclick="window.openStreakPage()" class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm transition-all hover:border-brand-300 hover:shadow-md active:scale-95 group">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-amber-500 group-hover:scale-110 transition-transform">
                        <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 00-1.071-.136 9.742 9.742 0 00-3.539 6.177A7.547 7.547 0 016.648 6.61a.75.75 0 00-1.152-.082A9 9 0 1015.68 4.534a7.46 7.46 0 01-2.717-2.248zM15.75 14.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-bold text-gray-700 font-sans">5</span>
                </button>
                
                <button onclick="window.openProfileModal()" class="relative group">
                    <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=100&q=80" class="w-9 h-9 rounded-full border-2 border-white shadow-sm object-cover transition-transform group-active:scale-95" alt="Profile">
                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 pb-20 relative flex flex-col">
            <!-- Content injected via JS -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center h-20 absolute bottom-0 w-full z-30 pb-2 transition-transform duration-300">
            <button onclick="window.switchTab('stories')" id="nav-stories" class="flex flex-col items-center justify-center w-1/3 h-full text-brand-600 relative group">
                <div class="absolute top-0 w-1/2 h-0.5 bg-brand-600 rounded-b-full transition-all duration-300" id="indicator-stories"></div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1 transition-transform group-active:scale-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
                <span class="text-[10px] font-bold uppercase tracking-wide">Stories</span>
            </button>
            <button onclick="window.switchTab('vocabulary')" id="nav-vocabulary" class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 hover:text-gray-600 relative group">
                <div class="absolute top-0 w-1/2 h-0.5 bg-transparent rounded-b-full transition-all duration-300" id="indicator-vocabulary"></div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1 transition-transform group-active:scale-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                </svg>
                <span class="text-[10px] font-bold uppercase tracking-wide">Vocab</span>
            </button>
            <button onclick="window.switchTab('flashcards')" id="nav-flashcards" class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 hover:text-gray-600 relative group">
                <div class="absolute top-0 w-1/2 h-0.5 bg-transparent rounded-b-full transition-all duration-300" id="indicator-flashcards"></div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1 transition-transform group-active:scale-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9" />
                </svg>
                <span class="text-[10px] font-bold uppercase tracking-wide">Review</span>
            </button>
        </nav>

        <!-- AI Modal Overlay -->
        <div id="ai-modal" class="absolute inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform scale-95 transition-transform duration-300" id="ai-modal-content"></div>
        </div>

        <!-- Profile / Menu Modal Overlay -->
        <div id="profile-modal" class="absolute inset-0 bg-black/50 z-50 hidden transition-opacity duration-300 opacity-0">
            <div class="absolute inset-0 z-0" onclick="window.closeProfileModal()"></div>
            <div class="absolute bottom-0 left-0 w-full bg-gray-50 rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full h-[90%]" id="profile-panel">
                
                <!-- Main Profile View -->
                <div id="profile-main-view" class="h-full flex flex-col">
                    <!-- Handle bar -->
                    <div class="w-full flex justify-center pt-3 pb-1 shrink-0" onclick="window.closeProfileModal()">
                        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto no-scrollbar pb-20">
                        <div class="p-6">
                            <!-- Header -->
                            <div class="flex justify-between items-start mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Menu</h2>
                                <button onclick="window.closeProfileModal()" class="p-2 bg-white rounded-full text-gray-400 hover:text-gray-600 shadow-sm border border-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            
                            <!-- Profile Card -->
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 mb-6">
                                <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=150&q=80" class="w-16 h-16 rounded-full object-cover border-2 border-gray-50 shadow-sm">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">Alex Student</h3>
                                    <div onclick="window.openStreakPage(); window.closeProfileModal()" class="flex items-center gap-2 mt-1 cursor-pointer group">
                                         <div class="flex items-center gap-1.5 px-2 py-0.5 rounded border border-gray-100 bg-gray-50 group-hover:border-brand-200 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5 text-amber-500"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 00-1.071-.136 9.742 9.742 0 00-3.539 6.177A7.547 7.547 0 016.648 6.61a.75.75 0 00-1.152-.082A9 9 0 1015.68 4.534a7.46 7.46 0 01-2.717-2.248zM15.75 14.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" /></svg>
                                            <span class="text-xs font-bold text-gray-600">5 Days</span>
                                         </div>
                                         <span class="text-gray-300">â€¢</span>
                                         <span class="text-sm text-gray-500" id="profile-word-count">143 Words</span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="bg-yellow-50 text-yellow-700 text-[10px] font-bold px-2 py-0.5 rounded border border-yellow-100 flex items-center inline-block w-fit gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path fill-rule="evenodd" d="M9 4.5a.75.75 0 01.721.544l.813 2.846a3.75 3.75 0 002.576 2.576l2.846.813a.75.75 0 010 1.442l-2.846.813a3.75 3.75 0 00-2.576 2.576l-.813 2.846a.75.75 0 01-1.442 0l-.813-2.846a3.75 3.75 0 00-2.576-2.576l-2.846-.813a.75.75 0 010-1.442l2.846-.813a3.75 3.75 0 002.576-2.576l.813-2.846A.75.75 0 019 4.5zM18 1.5a.75.75 0 01.728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 010 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 01-1.456 0l-.258-1.036a2.625 2.625 0 00-1.91-1.91l-1.036-.258a.75.75 0 010-1.456l1.036-.258a2.625 2.625 0 001.91-1.91l.258-1.036A.75.75 0 0118 1.5zM16.5 15a.75.75 0 01.712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 010 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 01-1.422 0l-.395-1.183a1.5 1.5 0 00-.948-.948l-1.183-.395a.75.75 0 010-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0116.5 15z" clip-rule="evenodd" /></svg>
                                            Full version active
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Subscription Section -->
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Subscription</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                                <button onclick="window.openSubscriptionPage()" class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-brand-50 text-brand-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Manage Subscription</span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </button>
                            </div>
                            
                            <!-- General Section -->
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">General</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                                <!-- ACTIVITY BUTTON -->
                                <button onclick="window.openStreakPage()" class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors border-b border-gray-50">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                                                <path fill-rule="evenodd" d="M2.25 13.5a8.25 8.25 0 018.25-8.25.75.75 0 01.75.75v6.75H18a.75.75 0 01.75.75 8.25 8.25 0 01-16.5 0zm9.75-12c5.63 0 10.193 4.563 10.193 10.193 0 1.148-.228 2.247-.64 3.269l-7.793-7.793z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Activity</span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </button>

                                <!-- SETTINGS BUTTON -->
                                <button onclick="window.openSettingsPage()" class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors border-b border-gray-50">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Settings</span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </button>
                                
                                <button class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors border-b border-gray-50">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Other languages</span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </button>
                                
                                <button class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-teal-50 text-teal-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Backups</span>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </button>
                            </div>
                            
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Support</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                                <button class="w-full px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-500 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Help & Support</span>
                                    </div>
                                </button>
                            </div>

                            <button class="w-full py-3.5 text-red-500 font-bold text-sm bg-red-50 rounded-2xl hover:bg-red-100 transition-colors mb-4">
                                Sign Out
                            </button>
                            
                            <p class="text-center text-xs text-gray-400 font-medium">Delight v2.1.0</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Sub-Page (Hidden by default, slides in) -->
                <div id="settings-view" class="absolute inset-0 bg-gray-50 translate-x-full transition-transform duration-300 flex flex-col z-20">
                      <div class="bg-white px-5 py-3 border-b border-gray-100 flex items-center gap-3 shrink-0">
                         <button onclick="window.closeSettingsPage()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                         </button>
                         <h2 class="text-lg font-bold text-gray-800">Settings</h2>
                    </div>
                    
                    <!-- Settings Tabs -->
                    <div class="px-5 pt-4 pb-2">
                        <div class="flex p-1 bg-gray-100 rounded-xl">
                            <button onclick="window.switchSettingsTab('general')" id="tab-settings-general" class="flex-1 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-brand-600 transition-all">General</button>
                            <button onclick="window.switchSettingsTab('stories')" id="tab-settings-stories" class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:bg-white/50 transition-all">Stories</button>
                            <button onclick="window.switchSettingsTab('review')" id="tab-settings-review" class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:bg-white/50 transition-all">Review</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar p-6">
                        
                        <!-- GENERAL SETTINGS CONTENT -->
                        <div id="settings-content-general" class="space-y-6 animate-fade-in">
                             <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Appearance</h3>
                             <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Color theme</span>
                                    <span class="text-sm text-gray-400 flex items-center gap-1">System <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span>
                                </div>
                             </div>

                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Notifications</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Enable notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                                <div class="p-4 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Reminder time</p>
                                        <p class="text-xs text-gray-400">20:00 Daily</p>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-300"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </div>
                            </div>
                            
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Account</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Sync user data</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                                </div>
                            </div>
                            
                            <button class="w-full text-center text-xs text-red-400 hover:text-red-600 font-medium pt-2">Delete account</button>
                        </div>

                        <!-- STORIES SETTINGS CONTENT -->
                        <div id="settings-content-stories" class="space-y-6 hidden animate-fade-in">
                            <h3 class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-2">Reading Experience</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Show translations</p>
                                        <p class="text-xs text-gray-400">Default visibility</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Auto-play audio</p>
                                        <p class="text-xs text-gray-400">When opening a story</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                                <div class="p-4 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Font Style</span>
                                    <span class="text-sm text-gray-400 flex items-center gap-1">Serif <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span>
                                </div>
                            </div>
                            
                            <h3 class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-2">Learning Aids</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Highlight keywords</p>
                                        <p class="text-xs text-gray-400">Underline learning words</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- REVIEW SETTINGS CONTENT -->
                        <div id="settings-content-review" class="space-y-6 hidden animate-fade-in">
                            <h3 class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-2">Flashcards</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Daily new words</span>
                                    <div class="flex items-center gap-3">
                                        <button class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200">-</button>
                                        <span class="text-sm font-bold text-gray-800">5</span>
                                        <button class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200">+</button>
                                    </div>
                                </div>
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Review limit</span>
                                    <span class="text-sm text-gray-400 flex items-center gap-1">50 cards <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span>
                                </div>
                                <div class="p-4 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Show transcription</p>
                                        <p class="text-xs text-gray-400">IPA pronunciation</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <h3 class="text-xs font-bold text-brand-600 uppercase tracking-wider mb-2">Audio & Animation</h3>
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Auto-play on flip</p>
                                        <p class="text-xs text-gray-400">Hear pronunciation</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                                 <div class="p-4 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Card animation</p>
                                        <p class="text-xs text-gray-400">Reduce motion</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- New Streak View -->
                <div id="streak-view" class="absolute inset-0 bg-gray-50 translate-x-full transition-transform duration-300 flex flex-col z-40">
                    <div class="bg-white px-5 py-3 border-b border-gray-100 flex items-center gap-3 shrink-0">
                        <button onclick="window.closeStreakPage()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <h2 class="text-lg font-bold text-gray-800">Activity</h2>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <h3 class="text-lg font-bold text-gray-900">Reading Streak</h3>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-amber-500"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 00-1.071-.136 9.742 9.742 0 00-3.539 6.177A7.547 7.547 0 016.648 6.61a.75.75 0 00-1.152-.082A9 9 0 1015.68 4.534a7.46 7.46 0 01-2.717-2.248zM15.75 14.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Current</p>
                                    <p class="text-3xl font-bold text-gray-900">7 <span class="text-base font-normal text-gray-500">Days</span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">Highest</p>
                                    <p class="text-3xl font-bold text-gray-900">28 <span class="text-base font-normal text-gray-500">Days</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Learning Progress</h3>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Marked as learned</p>
                                    <p class="text-3xl font-bold text-gray-900">144 <span class="text-base font-normal text-gray-500">Stories</span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">Learned</p>
                                    <p class="text-3xl font-bold text-gray-900">450 <span class="text-base font-normal text-gray-500">Words</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">Reading Tracker</h3>
                            <p class="text-xs text-gray-400 mb-4">145 stories read</p>
                            <h4 class="text-xl font-bold text-gray-900 mb-3">2026</h4>
                            <div class="flex gap-2">
                                <div class="flex flex-col justify-between text-[10px] text-gray-400 py-1 h-[140px]">
                                    <span>Mon</span>
                                    <span>&nbsp;</span>
                                    <span>Wed</span>
                                    <span>&nbsp;</span>
                                    <span>Fri</span>
                                    <span>&nbsp;</span>
                                    <span>Sun</span>
                                </div>
                                <div class="flex-1 overflow-x-auto no-scrollbar">
                                    <div id="heatmap-container" class="heatmap-grid w-max h-[140px]"></div>
                                    <div class="flex justify-between text-[10px] text-gray-400 mt-2 px-1 w-full max-w-[280px]">
                                        <span>Dec</span>
                                        <span>Jan</span>
                                        <span>Feb</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription View -->
                <div id="subscription-view" class="absolute inset-0 bg-white translate-y-full transition-transform duration-300 flex flex-col z-30">
                      <div class="absolute top-4 right-4 z-20">
                          <button onclick="window.closeSubscriptionPage()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                      </div>
                      
                      <div class="flex-1 flex flex-col items-center justify-center p-8 text-center relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-brand-50 to-white -z-10"></div>
                         <div class="w-20 h-20 bg-gradient-to-tr from-brand-400 to-teal-300 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-100 mb-6 rotate-3">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-white"><path fill-rule="evenodd" d="M5.166 2.621v.858c-1.035.148-2.059.33-3.071.543a.75.75 0 00-.584.859 6.753 6.753 0 006.138 5.6 6.73 6.73 0 002.743 1.346A6.707 6.707 0 019.279 15H8.54c-1.036 0-1.875.84-1.875 1.875V19.5h-.75a2.25 2.25 0 00-2.25 2.25c0 .414.336.75.75.75h14.25c.414 0 .75-.336.75-.75a2.25 2.25 0 00-2.25-2.25h-.75v-2.625c0-1.036-.84-1.875-1.875-1.875h-.739a6.706 6.706 0 01-1.612-3.179 6.753 6.753 0 006.139-5.6.75.75 0 00-.585-.858 47.077 47.077 0 00-3.07-.543V2.62a.75.75 0 00-.656-.744c-2.263-.206-4.636-.206-6.908 0a.75.75 0 00-.656.745zm4.085 7.42a5.253 5.253 0 001.077.587c.318.125.663.125.98 0 .324-.124.695-.327 1.078-.587a5.242 5.242 0 001.768-2.128c.45-1.01.693-2.073.743-3.176a48.563 48.563 0 00-5.783 0c.05 1.103.293 2.166.743 3.176a5.243 5.243 0 001.768 2.128h.001z" clip-rule="evenodd" /></svg>
                         </div>
                         <h2 class="text-3xl font-bold text-gray-900 mb-2">Go Premium</h2>
                         <p class="text-gray-500 mb-10 max-w-xs">Unlock the full potential of your language learning journey.</p>
                         <div class="space-y-4 w-full max-w-xs mb-10">
                             <div class="flex items-center gap-3">
                                 <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg></div>
                                 <span class="text-sm font-medium text-gray-700">Unlimited AI Stories</span>
                             </div>
                             <div class="flex items-center gap-3">
                                 <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg></div>
                                 <span class="text-sm font-medium text-gray-700">Smart Grammar Analysis</span>
                             </div>
                             <div class="flex items-center gap-3">
                                 <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg></div>
                                 <span class="text-sm font-medium text-gray-700">Pronunciation Coach</span>
                             </div>
                         </div>
                         <div class="w-full bg-white border-2 border-brand-500 rounded-2xl p-4 relative mb-6 shadow-sm">
                             <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-brand-500 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wide">Best Value</div>
                             <p class="text-sm text-gray-500 font-medium mb-1">Annual Plan</p>
                             <div class="flex items-baseline justify-center gap-1">
                                 <span class="text-xs font-bold text-gray-400 align-top">HKD</span>
                                 <span class="text-3xl font-bold text-gray-900">349.00</span>
                                 <span class="text-xs text-gray-400">/ year</span>
                             </div>
                             <p class="text-[10px] text-gray-400 mt-2">Less than HKD 30 / month</p>
                         </div>
                         <button onclick="window.handleSubscribe()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-200 transition-transform active:scale-95 text-lg">
                             Subscribe Now
                         </button>
                         <p class="text-[10px] text-gray-400 mt-4 text-center px-4">
                             Payment will be charged to your iTunes account at confirmation of purchase. Subscription automatically renews unless auto-renew is turned off at least 24-hours before the end of the current period.
                         </p>
                      </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const apiKey = ""; 
        const DB_KEY = 'linguaContext_data_v3';

        const initialFlashcardData = [
            { id: 1, word: "verhindern", translation: "to prevent", ipa: "/fÉ›ÉÌ¯ËˆhÉªndÉn/", level: "B1", type: "verb", image: "https://images.unsplash.com/photo-1584036561566-b93a50208c3c?auto=format&fit=crop&w=600&q=80", currentInterval: 0, nextReviewDate: 0, sentences: [{ de: "Wir mÃ¼ssen diesen Fehler verhindern.", en: "We must prevent this mistake." }, { de: "Nichts kann mich daran verhindern.", en: "Nothing can prevent me from doing it." }] },
            { id: 3, word: "glÃ¼cklich", translation: "happy", ipa: "/ËˆÉ¡lÊklÉªÃ§/", level: "A1", type: "adjective", image: "https://images.unsplash.com/photo-1544717305-2782549b5136?auto=format&fit=crop&w=600&q=80", currentInterval: 0, nextReviewDate: 0, sentences: [{ de: "Ich bin sehr glÃ¼cklich heute.", en: "I am very happy today." }, { de: "Geld allein macht nicht glÃ¼cklich.", en: "Money alone does not make you happy." }] },
            { id: 5, word: "reisen", translation: "to travel", ipa: "/ËˆÊaÉªÌ¯znÌ©/", level: "A2", type: "verb", image: "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=600&q=80", currentInterval: 0, nextReviewDate: 0, sentences: [{ de: "Ich reise gerne nach Japan.", en: "I like traveling to Japan." }, { de: "Wir reisen oft im Sommer.", en: "We travel often in the summer." }] },
            { id: 2, word: "der Zug", translation: "the train", ipa: "/tÍ¡suËk/", level: "A1", type: "noun", image: "https://images.unsplash.com/photo-1474487548417-781cb71495f3?auto=format&fit=crop&w=600&q=80", currentInterval: 1, nextReviewDate: Date.now() - 10000, sentences: [{ de: "Der Zug kommt um acht Uhr.", en: "The train comes at eight o'clock." }, { de: "Ich fahre lieber mit dem Zug als mit dem Bus.", en: "I prefer traveling by train than by bus." }] },
            { id: 4, word: "die Tasche", translation: "the bag", ipa: "/ËˆtaÊƒÉ™/", level: "A1", type: "noun", image: "https://images.unsplash.com/photo-1590874103328-eac38a683ce7?auto=format&fit=crop&w=600&q=80", currentInterval: 3, nextReviewDate: Date.now() + 2 * 60 * 60 * 1000, sentences: [{ de: "Wo ist meine Tasche?", en: "Where is my bag?" }, { de: "Ich habe meine Tasche im Zug vergessen.", en: "I forgot my bag on the train." }] },
        ];

        // Safe initialization
        let flashcardData;
        try {
            flashcardData = JSON.parse(localStorage.getItem(DB_KEY)) || initialFlashcardData;
        } catch (e) {
            flashcardData = initialFlashcardData;
        }

        function saveFlashcardData() {
            localStorage.setItem(DB_KEY, JSON.stringify(flashcardData));
        }

        const keywordsData = [
            { id: 1, word: "Sommer", level: "A1", article: "der", type: "Noun", plural: "die Sommer", ipa: "/ËˆzÉ”mÉ/", english: "summer", context: "Der Sommer in Berlin ist wunderschÃ¶n.", example: "Ich mag den Sommer.", example_en: "I like the summer." },
            { id: 2, word: "Stadt", level: "A1", article: "die", type: "Noun", plural: "die StÃ¤dte", ipa: "/Êƒtat/", english: "city", context: "Ich liebe diese Stadt.", example: "Berlin ist eine groÃŸe Stadt.", example_en: "Berlin is a big city." },
            { id: 3, word: "schÃ¶n", level: "A1", article: null, type: "Adj", plural: null, ipa: "/ÊƒÃ¸Ën/", english: "beautiful", context: "Der Sommer ist wunderschÃ¶n.", example: "Das Wetter ist schÃ¶n.", example_en: "The weather is beautiful." }
        ];

        let stories = [
            { id: 1, title: "Berlin im Sommer", level: "A2", image: "https://images.unsplash.com/photo-1560969184-10fe8719e047?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Experience the vibrant culture of Berlin during the warm summer months.", content: { german: "Der Sommer in Berlin ist wunderschÃ¶n.", english: "Summer in Berlin is beautiful." }, isLearned: false },
            { id: 2, title: "Der neue Job", level: "B1", image: "https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Lisa starts her first day.", content: {}, isLearned: false },
            { id: 3, title: "Guten Morgen", level: "A1", image: "https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Learn about daily morning routines.", content: { german: "Ich wache um sieben Uhr auf.", english: "I wake up at seven o'clock." }, isLearned: false },
            { id: 4, title: "Im Supermarkt", level: "A1", image: "https://images.unsplash.com/photo-1578916171728-46686eac8d58?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Shopping for groceries.", content: { german: "Ich brauche Milch und Brot.", english: "I need milk and bread." }, isLearned: true },
            { id: 5, title: "Mein Wochenende", level: "A2", image: "https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Spending time in the mountains.", content: { german: "Am Wochenende gehe ich wandern.", english: "On the weekend I go hiking." }, isLearned: false },
            { id: 6, title: "Eine Reise nach MÃ¼nchen", level: "B1", image: "https://images.unsplash.com/photo-1595867865323-286a83a0a32b?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "Discovering the capital of Bavaria.", content: {}, isLearned: false },
            { id: 7, title: "Das Oktoberfest", level: "B1", image: "https://images.unsplash.com/photo-1534351590666-13e3e96b5017?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "The world's largest Volksfest.", content: {}, isLearned: false },
            { id: 8, title: "Technologie heute", level: "B2", image: "https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", description: "How computers change our lives.", content: {}, isLearned: false },
        ];

        // --- State Variables ---
        let currentTab = 'stories';
        let currentLevelFilter = 'All';
        let currentStoryId = null;
        let isEnglishVisible = false;
        let currentSubTab = 'read';
        let fontSizeIndex = 1;
        const fontSizes = ['text-base', 'text-lg', 'text-xl'];
        let isStoryLiked = false;
        let isReviewDashboard = true; 
        let currentSessionCards = []; 
        let currentCardIndex = 0;
        let isCardFlipped = false;
        let learnedCardsCount = 0;
        let lookupState = null;
        let activeWordId = null;
        let quizStep = 'start'; 
        let q1Status = null;
        let q2Pool = ['Berlin', 'ist', 'wunderschÃ¶n', 'sehr'];
        let q2Answer = [];
        let q3Status = null;
        let q4Status = null;
        let hideLearnedStories = false;

        // --- Helper Functions ---
        function playAudio(e) {
            if(e) e.stopPropagation();
            if(e && e.currentTarget) {
                const btn = e.currentTarget;
                btn.classList.add('text-brand-500', 'scale-110');
                setTimeout(() => btn.classList.remove('text-brand-500', 'scale-110'), 300);
            }
        }

        function initSwipeGestures() {
            const card = document.getElementById('card-inner');
            if (!card) return;

            let startX = 0;
            let isSwiping = false;

            card.addEventListener('pointerdown', e => {
                if (e.target.closest('button')) return;
                startX = e.clientX;
                isSwiping = true;
                card.style.transition = 'none'; 
                card.setPointerCapture(e.pointerId);
            });

            card.addEventListener('pointermove', e => {
                if (!isSwiping) return;
                const deltaX = e.clientX - startX;
                const rotate = deltaX * 0.05;
                card.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
            });

            card.addEventListener('pointerup', e => {
                if (!isSwiping) return;
                isSwiping = false;
                card.releasePointerCapture(e.pointerId);
                const deltaX = e.clientX - startX;
                card.style.transition = 'transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1)'; 

                if (deltaX < -100) {
                    card.classList.add('slide-out-left');
                    setTimeout(() => window.nextCard('know'), 300);
                } else if (deltaX > 100) {
                    card.style.transform = ''; 
                    window.flipCard();
                } else {
                    card.style.transform = isCardFlipped ? 'rotateY(180deg)' : '';
                    if (Math.abs(deltaX) < 10) {
                        window.flipCard();
                    }
                }
            });
        }

        function flipCard() {
            const cardInner = document.getElementById('card-inner');
            if (cardInner) {
                isCardFlipped = !isCardFlipped;
                cardInner.style.transform = isCardFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)';
                window.renderFlashcardControls();
            }
        }

        // --- Core Functions ---
        function nextCard(action) {
            isCardFlipped = false;
            setTimeout(() => {
                const card = currentSessionCards[currentCardIndex];
                if (action === 'know' || action === 'got-it' || action === 'good' || action === 'easy') {
                    learnedCardsCount++;
                }
                const now = Date.now();
                const ONE_DAY = 24 * 60 * 60 * 1000;
                const THIRTY_MINUTES = 30 * 60 * 1000;
                const ONE_MINUTE = 60 * 1000;

                if (action === 'know' || action === 'easy') {
                    card.currentInterval = Math.max(2, (card.currentInterval || 0) * 4);
                    card.nextReviewDate = now + card.currentInterval * ONE_DAY;
                } else if (action === 'good') {
                    card.currentInterval = Math.max(1, (card.currentInterval || 0) * 2.5);
                    card.nextReviewDate = now + card.currentInterval * ONE_DAY;
                } else if (action === 'got-it') {
                    card.currentInterval = 0.5; 
                    card.nextReviewDate = now + THIRTY_MINUTES;
                } else if (action === 'missed-it' || action === 'hard') {
                    card.currentInterval = 0; 
                    card.nextReviewDate = now + ONE_MINUTE;
                }
                const originalIndex = flashcardData.findIndex(c => c.id === card.id);
                if (originalIndex !== -1) {
                    flashcardData[originalIndex] = card;
                    saveFlashcardData();
                }
                currentCardIndex++;
                window.renderFlashcardsTab();
            }, 300); 
        }

        function renderFlashcardControls() {
            const controlsContainer = document.getElementById('flashcard-controls');
            if (!controlsContainer) return;
            const card = currentSessionCards[currentCardIndex];
            if (!card) return;
            const isNewWord = card.currentInterval === 0;
            let timeHard = "&lt; 1m";
            let timeGood = "2h";
            let timeEasy = "1d";
            if (!isNewWord) {
                timeHard = "1m";
                timeGood = `${Math.max(1, Math.round(card.currentInterval * 2.5))}d`;
                timeEasy = `${Math.max(2, Math.round(card.currentInterval * 4.0))}d`;
            }
            if (!isCardFlipped) {
                controlsContainer.innerHTML = `
                    <div class="flex justify-between items-center w-full px-6 gap-4 animate-fade-in">
                        <button onclick="document.getElementById('card-inner').classList.add('slide-out-left'); setTimeout(() => window.nextCard('know'), 300);" class="flex-1 py-4 rounded-xl border-2 border-gray-200 text-gray-500 font-bold hover:bg-gray-50 hover:border-gray-300 transition-all active:scale-95 flex items-center justify-center gap-2 bg-white">
                            <span class="text-lg">â€¹</span> I already know
                        </button>
                        <button onclick="window.flipCard()" class="flex-1 py-4 rounded-xl bg-brand-600 text-white font-bold shadow-lg shadow-brand-200 hover:bg-brand-500 transition-all active:scale-95 flex items-center justify-center gap-2">
                            ${isNewWord ? 'Learn' : 'Tap to Flip'} <span class="text-lg">â€º</span>
                        </button>
                    </div>
                `;
            } else {
                if (isNewWord) {
                    controlsContainer.innerHTML = `
                        <div class="flex gap-4 w-full px-4 animate-fade-in">
                            <button onclick="window.nextCard('missed-it')" class="flex-1 flex flex-col items-center justify-center py-3 rounded-xl border border-red-200 bg-red-50 text-red-600 active:scale-95 transition-all hover:bg-red-100 shadow-sm">
                                <span class="text-[10px] font-bold opacity-60 mb-0.5">&lt; 1m</span>
                                <span class="text-sm font-bold uppercase tracking-wider">Not yet</span>
                            </button>
                            <button onclick="window.nextCard('got-it')" class="flex-1 flex flex-col items-center justify-center py-3 rounded-xl border border-brand-200 bg-brand-50 text-brand-700 active:scale-95 transition-all hover:bg-brand-100 shadow-sm">
                                <span class="text-[10px] font-bold opacity-60 mb-0.5">30m</span>
                                <span class="text-sm font-bold uppercase tracking-wider">Got it</span>
                            </button>
                        </div>
                    `;
                } else {
                    controlsContainer.innerHTML = `
                        <div class="flex gap-3 w-full px-4 animate-fade-in">
                            <button onclick="window.nextCard('hard')" class="flex-1 flex flex-col items-center justify-center py-2.5 rounded-xl border border-orange-200 bg-orange-50 text-orange-700 active:scale-95 transition-all hover:bg-orange-100 shadow-sm">
                                <span class="text-[10px] font-bold opacity-60 mb-0.5">${timeHard}</span>
                                <span class="text-xs font-bold uppercase tracking-wider">Hard</span>
                            </button>
                            <button onclick="window.nextCard('good')" class="flex-1 flex flex-col items-center justify-center py-2.5 rounded-xl border border-brand-200 bg-brand-50 text-brand-700 active:scale-95 transition-all hover:bg-brand-100 shadow-sm">
                                <span class="text-[10px] font-bold opacity-60 mb-0.5">${timeGood}</span>
                                <span class="text-xs font-bold uppercase tracking-wider">Good</span>
                            </button>
                            <button onclick="window.nextCard('easy')" class="flex-1 flex flex-col items-center justify-center py-2.5 rounded-xl border border-blue-200 bg-blue-50 text-blue-700 active:scale-95 transition-all hover:bg-blue-100 shadow-sm">
                                <span class="text-[10px] font-bold opacity-60 mb-0.5">${timeEasy}</span>
                                <span class="text-xs font-bold uppercase tracking-wider">Easy</span>
                            </button>
                        </div>
                    `;
                }
            }
        }

        function startSession(type) {
            const now = Date.now();
            if (type === 'new') {
                currentSessionCards = flashcardData.filter(c => c.currentInterval === 0 && (c.nextReviewDate || 0) <= now);
            } else if (type === 'review') {
                currentSessionCards = flashcardData.filter(c => c.currentInterval > 0 && (c.nextReviewDate || 0) <= now);
            }
            
            currentCardIndex = 0;
            learnedCardsCount = 0;
            isCardFlipped = false;
            isReviewDashboard = false;
            
            window.renderFlashcardsTab();
        }

        function renderReviewDashboard() {
            const now = Date.now();
            const newCards = flashcardData.filter(c => c.currentInterval === 0 && (c.nextReviewDate || 0) <= now);
            const reviewCards = flashcardData.filter(c => c.currentInterval > 0 && (c.nextReviewDate || 0) <= now);
            
            const upcomingReviewCards = flashcardData.filter(c => c.currentInterval > 0 && (c.nextReviewDate || 0) > now);
            let reviewSubtext = "Nothing to review yet";
            
            if (reviewCards.length > 0) {
                reviewSubtext = `${reviewCards.length} words ready for review`;
            } else if (upcomingReviewCards.length > 0) {
                const closest = upcomingReviewCards.sort((a,b) => a.nextReviewDate - b.nextReviewDate)[0];
                const diffMins = Math.ceil((closest.nextReviewDate - now) / 60000);
                if (diffMins < 60) {
                    reviewSubtext = `Next review in ${diffMins} minutes`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    reviewSubtext = `Next review in ${diffHours} hour${diffHours > 1 ? 's' : ''}`;
                }
            }

            const upcomingNewCards = flashcardData.filter(c => c.currentInterval === 0 && (c.nextReviewDate || 0) > now);
            let newSubtext = newCards.length > 0 ? `${newCards.length} words ready` : "All done for today!";
            
            return `
                <div class="p-6 pb-24 bg-gray-50 min-h-full animate-fade-in">
                    <div class="flex justify-between items-end mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Spaced Repetition</h2>
                        <button onclick="localStorage.removeItem(DB_KEY); location.reload();" class="text-[10px] text-gray-400 hover:underline">Reset Data</button>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                        <!-- Learn New Words -->
                        <div onclick="${newCards.length > 0 ? "window.startSession('new')" : ""}" class="p-5 border-b border-gray-50 flex items-center justify-between transition-colors ${newCards.length > 0 ? 'cursor-pointer hover:bg-gray-50 active:bg-gray-100' : 'opacity-60 grayscale'}">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg">Learn new words</h3>
                                    <p class="text-sm text-gray-500">${newSubtext}</p>
                                </div>
                            </div>
                            <div class="text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </div>

                        <!-- Review Words -->
                        <div onclick="${reviewCards.length > 0 ? "window.startSession('review')" : ""}" class="p-5 flex items-center justify-between transition-colors ${reviewCards.length > 0 ? 'cursor-pointer hover:bg-gray-50 active:bg-gray-100' : 'opacity-60 grayscale'}">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg">Review words</h3>
                                    <p class="text-sm text-gray-500">${reviewSubtext}</p>
                                </div>
                            </div>
                            <div class="text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-800 mb-4 tracking-tight">Extra modes</h3>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                        <div class="p-5 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors" onclick="window.switchTab('vocabulary')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-green-50 text-green-500 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg">Browse flashcards</h3>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSessionView(container) {
            if (currentCardIndex >= currentSessionCards.length) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-8 animate-fade-in relative">
                        <button onclick="isReviewDashboard=true; window.renderFlashcardsTab();" class="absolute top-6 left-6 text-gray-400 hover:text-gray-800 bg-white shadow-sm p-2 rounded-full transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5" /></svg>
                        </button>
                        <div class="w-32 h-32 bg-brand-100 rounded-full flex items-center justify-center mb-6 text-brand-600 animate-bounce-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">You're all set!</h2>
                        <p class="text-gray-500 text-center mb-8 max-w-xs">You've successfully processed ${learnedCardsCount} cards. Great job keeping up the streak!</p>
                        <button onclick="isReviewDashboard=true; window.renderFlashcardsTab();" class="px-8 py-3 rounded-full bg-brand-600 text-white font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 transition-all active:scale-95">Back to Dashboard</button>
                    </div>
                `;
                return;
            }

            const card = currentSessionCards[currentCardIndex];

            container.innerHTML = `
                <div class="flex-1 flex flex-col relative bg-gray-100">
                    <div class="absolute top-4 left-4 z-10">
                        <button onclick="isReviewDashboard=true; window.renderFlashcardsTab();" class="w-10 h-10 rounded-full bg-white/70 backdrop-blur text-gray-700 flex items-center justify-center shadow-sm hover:bg-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 pr-0.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                    </div>

                    <div class="w-full bg-gray-200 h-1">
                        <div class="bg-brand-500 h-1 transition-all duration-300" style="width: ${(currentCardIndex / currentSessionCards.length) * 100}%"></div>
                    </div>
                    
                    <div class="flex-1 p-6 flex flex-col justify-center perspective-container">
                        <div id="card-inner" class="relative w-full aspect-[3/4] max-h-[580px] cursor-pointer flip-card-inner shadow-card rounded-3xl slide-in">
                            
                            <!-- FRONT -->
                            <div class="flip-card-front flex flex-col overflow-hidden border border-gray-100 bg-white shadow-sm">
                                <div class="h-[45%] w-full relative bg-gray-50">
                                    <img src="${card.image}" class="w-full h-full object-cover" alt="${card.word}">
                                    <div class="absolute top-4 right-4 bg-white/30 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-md border border-white/20 shadow-sm uppercase tracking-wider">
                                        ${card.level} â€¢ ${card.type}
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col items-center pt-8 px-6 relative">
                                    <div class="text-center w-full">
                                        <div class="flex items-center justify-center gap-3 mb-2 min-h-[3rem]">
                                            <h2 class="text-3xl font-bold text-gray-900 tracking-tight">${card.word}</h2>
                                            <button onclick="window.playAudio(event)" class="w-10 h-10 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center hover:bg-brand-100 hover:scale-105 transition-all shadow-sm shrink-0">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 01-1.06-1.06 8.25 8.25 0 000-4.244.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.061 0 4.5 4.5 0 010 6.364.75.75 0 01-1.06-1.061 3 3 0 000-4.244.75.75 0 010-1.06z" /></svg>
                                            </button>
                                        </div>
                                        <p class="text-gray-400 font-mono text-lg">${card.ipa}</p>
                                    </div>
                                    <div class="absolute bottom-6 text-xs text-gray-300 font-bold uppercase tracking-widest animate-pulse">Tap or swipe to flip</div>
                                </div>
                            </div>

                            <!-- BACK -->
                            <div class="flip-card-back flex flex-col overflow-hidden border border-gray-100 bg-white shadow-sm">
                                <div class="h-[40%] w-full relative bg-gray-50">
                                    <img src="${card.image}" class="w-full h-full object-cover" alt="${card.word}">
                                     <div class="absolute top-4 right-4 bg-white/30 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-md border border-white/20 shadow-sm uppercase tracking-wider opacity-50">
                                        ${card.level} â€¢ ${card.type}
                                    </div>
                                </div>

                                <div class="flex-1 flex flex-col items-center pt-4 px-5 relative overflow-y-auto no-scrollbar">
                                    <div class="text-center w-full mb-4">
                                         <h3 class="text-lg font-bold text-gray-400 mb-1">${card.word}</h3>
                                         <h2 class="text-3xl font-serif italic text-brand-700 tracking-tight">${card.translation}</h2>
                                    </div>
                                    <div class="w-full space-y-3 pb-4">
                                        ${card.sentences.map(s => `
                                            <div class="w-full bg-gray-50 rounded-xl p-3 text-left border-l-4 border-brand-500 relative group shadow-sm transition-all hover:bg-white hover:shadow-md cursor-pointer" onclick="window.playAudio(event)">
                                                <div class="pr-8">
                                                    <p class="text-gray-800 text-sm font-medium mb-1 leading-snug">${s.de}</p>
                                                    <p class="text-gray-500 text-xs">${s.en}</p>
                                                </div>
                                                <button class="absolute top-3 right-2 text-brand-300 hover:text-brand-600 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm14.024-.983a1.125 1.125 0 010 1.966l-5.603 3.113A1.125 1.125 0 019 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113z" clip-rule="evenodd" /></svg>
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div id="flashcard-controls" class="pb-6 pt-2 w-full max-w-md mx-auto">
                        <!-- Controls Injected Here -->
                    </div>
                </div>
            `;
            
            window.renderFlashcardControls();
            window.initSwipeGestures();
        }

        function renderFlashcardsTab() {
            const container = document.getElementById('main-content');
            if (!container) return;
            
            if (isReviewDashboard) {
                container.innerHTML = renderReviewDashboard();
            } else {
                renderSessionView(container);
            }
        }

        function renderStoriesTab() {
            const container = document.getElementById('main-content');
            if (!container) return;
            container.scrollTop = 0;

            const filteredStories = stories.filter(s => {
                if (hideLearnedStories && s.isLearned) return false;
                if (currentLevelFilter === 'All') return true;
                return s.level === currentLevelFilter;
            });

            container.innerHTML = `
                <div class="p-6 pb-24 animate-fade-in">
                    <!-- Header -->
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Discover</h2>
                    </div>

                    <!-- Level Filters -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                            ${['All', 'A1', 'A2', 'B1'].map(level => `
                                <button onclick="currentLevelFilter = '${level}'; window.renderStoriesTab()" 
                                    class="px-4 py-1.5 rounded-full font-bold text-sm whitespace-nowrap transition-all ${currentLevelFilter === level ? 'bg-gray-800 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'}">
                                    ${level}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex justify-end mb-4">
                        <button onclick="window.toggleHideLearned()" class="flex items-center gap-2 text-xs font-bold ${hideLearnedStories ? 'text-brand-600' : 'text-gray-400'} transition-colors hover:text-brand-500">
                            <div class="w-4 h-4 border-2 rounded ${hideLearnedStories ? 'bg-brand-600 border-brand-600' : 'border-gray-300'} flex items-center justify-center transition-colors">
                                ${hideLearnedStories ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 text-white"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg>' : ''}
                            </div>
                            Hide learned
                        </button>
                    </div>

                    <!-- Story List -->
                    <div class="space-y-4">
                        ${filteredStories.map(story => `
                            <div onclick="window.openStory(${story.id})" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-4 cursor-pointer hover:shadow-md transition-shadow active:scale-[0.99] relative overflow-hidden">
                                ${story.isLearned ? '<div class="absolute top-0 right-0 w-8 h-8 bg-green-500 text-white flex items-center justify-center rounded-bl-xl shadow-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg></div>' : ''}
                                <img src="${story.image}" class="w-24 h-24 rounded-lg object-cover shrink-0 bg-gray-200">
                                <div class="flex flex-col justify-center py-1 overflow-hidden">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">${story.level}</span>
                                        ${story.id > 100 ? '<span class="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">AI</span>' : ''}
                                    </div>
                                    <h4 class="font-bold text-gray-800 leading-tight mb-1 font-serif text-lg truncate">${story.title}</h4>
                                    <p class="text-xs text-gray-500 line-clamp-2 leading-relaxed">${story.description}</p>
                                </div>
                            </div>
                        `).join('')}
                        ${filteredStories.length === 0 ? '<div class="text-center py-10 text-gray-400">No stories found.</div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderVocabularyTab() {
            const container = document.getElementById('main-content');
            if (!container) return;
            container.scrollTop = 0;

            const categories = [
                { name: "Top 100", count: "101 words", percent: "61%", path: "M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25", color: "bg-emerald-100 text-emerald-600" },
                { name: "Top 1000", count: "1016 words", percent: "23%", path: "M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z", color: "bg-blue-100 text-blue-600" },
                { name: "Family", count: "43 words", percent: "100%", path: "M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z", color: "bg-red-100 text-red-600" },
                { name: "Furniture", count: "47 words", percent: "79%", path: "M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.186.06-2.377.127-3.573.222v4.03c0 .878.555 1.608 1.336 1.908M6.75 8.14c.001 3.08.038 6.125.115 9.122l3 3v-3.57b1.375 1.375 0 00-2.746-.902 50.59 50.59 0 01-1.408-7.802 14.215 14.215 0 01.539-.322c.94-.53 1.5-1.578 1.5-2.751V2.175c0-.921-.712-1.683-1.636-1.745a31.97 31.97 0 00-5.748 0C2.123 1.684 3 2.872 3 4.392v6.094M6.75 2.175l4.35 4.35", color: "bg-amber-100 text-amber-600" },
                { name: "Money", count: "162 words", percent: "25%", path: "M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z", color: "bg-green-100 text-green-600" },
                { name: "Months", count: "12 words", percent: "100%", path: "M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5", color: "bg-purple-100 text-purple-600" },
                { name: "Numerals (cardinal)", count: "30 words", percent: "100%", path: "M5.25 8.25h15m-16.5 7.5h15m-1.8-13.5l-3.9 19.5m-2.1-19.5l-3.9 19.5", color: "bg-blue-100 text-blue-600" },
                { name: "Seasons", count: "4 words", percent: "100%", path: "M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z", color: "bg-orange-100 text-orange-600" },
                { name: "Time", count: "14 words", percent: "100%", path: "M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z", color: "bg-rose-100 text-rose-600" },
                { name: "Transport", count: "38 words", percent: "82%", path: "M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12", color: "bg-gray-100 text-gray-600" },
                { name: "Verbs of movement", count: "51 words", percent: "100%", path: "M15 10.5a3 3 0 11-6 0 3 3 0 016 0zM1.5 20.25c2.215 2.155 5.445 3 8.76 2.457 4.28-.7 7.74-4.227 8.16-8.757.257-2.766-1.09-5.11-3.19-6.357-1.25-.742-2.72-1.082-4.18-1.082a9.69 9.69 0 00-4.17 1.082c-2.11 1.247-3.46 3.591-3.203 6.357.382 4.123 3.323 7.42 7.23 8.32", color: "bg-cyan-100 text-cyan-600" },
                { name: "Weather", count: "101 words", percent: "34%", path: "M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-3.758-3.848 5.25 5.25 0 00-10.233 2.33A4.502 4.502 0 002.25 15z", color: "bg-sky-100 text-sky-600" },
                { name: "City", count: "47 words", percent: "91%", path: "M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z", color: "bg-indigo-100 text-indigo-600" },
                { name: "Food & Drink", count: "88 words", percent: "15%", path: "M12.75 3.037a.75.75 0 00-1.5 0v2.25H9a.75.75 0 00-.75.75v1.5c0 .414.336.75.75.75h6a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75h-2.25V3.037zM6 10.5a3 3 0 013-3h6a3 3 0 013 3v2.25a3 3 0 01-3 3h-6a3 3 0 01-3-3V10.5zM3.75 18h16.5a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75H3.75a.75.75 0 00-.75.75v1.5a.75.75 0 00.75.75z", color: "bg-yellow-100 text-yellow-600" },
                { name: "Animals", count: "64 words", percent: "42%", path: "M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z", color: "bg-stone-100 text-stone-600" },
                { name: "Body parts", count: "32 words", percent: "58%", path: "M10.05 4.575a1.575 1.575 0 10-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 013.15 0v1.5m-3.15 0l.075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 013.15 0V15M6.9 7.575a1.575 1.575 0 10-3.15 0v8.175a6.75 6.75 0 006.75 6.75 6.75 6.75 0 006.75-6.75v-8.175a6.75 6.75 0 00-6.75-6.75h-3.6z", color: "bg-pink-100 text-pink-600" }
            ];

            container.innerHTML = `
                <div class="flex flex-col h-full bg-gray-50">
                    <div class="px-6 pt-6 pb-2 bg-white sticky top-0 z-10 border-b border-gray-50">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Vocabulary</h2>
                            <button class="text-brand-600 font-bold text-xs uppercase tracking-wide hover:bg-brand-50 px-3 py-1 rounded transition-colors">Import</button>
                        </div>
                        <div class="relative mb-2">
                            <input type="text" placeholder="Search for words..." class="w-full bg-gray-100 text-gray-700 rounded-xl py-3 pl-10 pr-4 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500/20 transition-all placeholder-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 space-y-2 animate-fade-in">
                        <div class="bg-white rounded-xl p-4 flex items-center gap-3 border border-gray-100 shadow-sm cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            </div>
                            <span class="font-bold text-gray-700 flex-1">Add category</span>
                        </div>
                        <div class="bg-white rounded-xl p-4 flex items-center gap-3 border border-gray-100 shadow-sm mb-4 cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533zM12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.47a.75.75 0 001-.708V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z" /></svg>
                            </div>
                            <span class="font-bold text-gray-700 flex-1">My words</span>
                        </div>

                        ${categories.map(cat => `
                            <div class="bg-white rounded-xl p-3 flex items-center gap-4 border border-gray-100 shadow-sm cursor-pointer hover:shadow-md transition-all active:scale-[0.99]">
                                <div class="w-12 h-12 rounded-xl ${cat.color} flex items-center justify-center text-2xl shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="${cat.path}" /></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-gray-800 truncate">${cat.name}</h4>
                                    <p class="text-xs text-gray-400 font-medium">${cat.count}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-gray-400 block">${cat.percent}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="absolute bottom-24 right-6 pointer-events-none">
                         <button class="bg-brand-500 hover:bg-brand-600 text-white rounded-full px-6 py-3 shadow-lg flex items-center gap-2 font-bold pointer-events-auto transition-transform active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Word
                         </button>
                    </div>
                </div>
            `;
        }

        // --- Window Binding (Explicit and Safe) ---
        function openStory(id) {
            currentStoryId = id;
            currentSubTab = 'read'; 
            initQuiz(); 
            const story = stories.find(s => s.id === id);
            
            const header = document.getElementById('top-bar');
            if(header) {
                header.classList.add('hidden');
            }

            const nav = document.querySelector('nav');
            if(nav) nav.classList.add('translate-y-full');
            
            renderStoryView(story);
        }

        function closeStory() {
            currentStoryId = null;
            lookupState = null;
            activeWordId = null;
            
            const header = document.getElementById('top-bar');
            if(header) {
                header.classList.remove('hidden');
            }
            
            const nav = document.querySelector('nav');
            if(nav) nav.classList.remove('translate-y-full');
            
            window.renderStoriesTab();
        }

        function setSubTab(tab) {
            currentSubTab = tab;
            lookupState = null;
            activeWordId = null;
            if (tab === 'quiz' && quizStep === 'start') initQuiz(); 
            const story = stories.find(s => s.id === currentStoryId);
            window.renderStoryView(story);
        }

        function toggleTranslation() {
            isEnglishVisible = !isEnglishVisible;
            const story = stories.find(s => s.id === currentStoryId);
            window.renderStoryView(story); 
        }

        function cycleFontSize() {
            fontSizeIndex = (fontSizeIndex + 1) % fontSizes.length;
            const story = stories.find(s => s.id === currentStoryId);
            window.renderStoryView(story);
        }

        function toggleLike() {
            isStoryLiked = !isStoryLiked;
            
            const btn = document.getElementById('like-btn');
            if (btn) {
                if (isStoryLiked) {
                    btn.classList.remove('text-gray-400', 'hover:text-pink-500');
                    btn.classList.add('text-pink-500');
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>`;
                } else {
                    btn.classList.remove('text-pink-500');
                    btn.classList.add('text-gray-400', 'hover:text-pink-500');
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>`;
                }
                
                // Add a small bounce animation
                btn.classList.add('scale-125');
                setTimeout(() => btn.classList.remove('scale-125'), 200);
            } else {
                // Fallback just in case
                const story = stories.find(s => s.id === currentStoryId);
                window.renderStoryView(story);
            }
        }

        function toggleStoryLearned(id) {
            const story = stories.find(s => s.id === id);
            if(story) {
                story.isLearned = !story.isLearned;
                // Only re-render the view if we are inside the story view, otherwise refresh list
                if (currentStoryId === id) {
                    renderStoryView(story);
                } else {
                    renderStoriesTab();
                }
            }
        }

        function toggleHideLearned() {
            hideLearnedStories = !hideLearnedStories;
            renderStoriesTab();
        }

        function lookupWord(word, element) {
            if(event) event.stopPropagation();
            activeWordId = word;
            
            const mocks = {
                "Sommer": { tr: "summer (noun)", ex: "Plural: die Sommer" },
                "Berlin": { tr: "Berlin (city)", ex: "Capital of Germany" },
                "wunderschÃ¶n": { tr: "beautiful", ex: "Adjective" },
                "Menschen": { tr: "people (noun)", ex: "Plural" },
                "CafÃ©s": { tr: "cafes (noun)", ex: "Plural" },
                "Sonne": { tr: "sun (noun)", ex: "Article: die" },
                "Gestern": { tr: "yesterday", ex: "Adverb" },
                "Park": { tr: "park (noun)", ex: "Article: der" },
                "Buch": { tr: "book (noun)", ex: "Article: das" },
                "entspannend": { tr: "relaxing", ex: "Adjective" },
                "Dort": { tr: "there", ex: "Adverb" },
                "Freund": { tr: "friend (noun)", ex: "Article: der" },
                "Eis": { tr: "ice cream", ex: "Article: das" },
                "Wetter": { tr: "weather (noun)", ex: "Article: das" },
                "liebe": { tr: "love (verb)", ex: "Infinitive: lieben" }
            };
            
            const data = mocks[word] || { tr: word, ex: "Click to see more" };
            lookupState = { word: word, translation: data.tr, extra: data.ex };
            
            const headerWrapper = document.getElementById('header-content-wrapper');
            if (headerWrapper) {
                 headerWrapper.innerHTML = `
                    <div class="pointer-events-auto animate-fade-in">
                        <h2 id="lookup-word" class="text-4xl font-bold text-white mb-2 tracking-tight">${lookupState.word}</h2>
                        <div class="flex items-baseline justify-center gap-2 mb-1">
                            <p id="lookup-translation" class="text-xl text-gray-200 font-medium">${lookupState.translation}</p>
                            <button class="text-white/80 hover:text-white ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.468 8.282a3.975 3.975 0 010 5.656m-3-2.828a1.975 1.975 0 010 2.828M5.25 12h8.5" /></svg>
                            </button>
                            <!-- AI Analyze Button -->
                            <button onclick="window.analyzeWord('${lookupState.word.replace(/'/g, "\\'")}')" class="bg-white/20 hover:bg-white/30 text-white text-xs font-bold px-2 py-1 rounded ml-2 backdrop-blur-sm transition-colors">
                                âœ¨ Analyze
                            </button>
                        </div>
                        <p id="lookup-extra" class="text-sm italic text-gray-400 font-medium bg-black/30 px-3 py-1 rounded-full backdrop-blur-sm mt-2 inline-block">${lookupState.extra}</p>
                    </div>`;
            }
            
            const allWords = document.querySelectorAll('.clickable-word, .active-word-highlight');
            allWords.forEach(span => {
                if (span.innerText === word) {
                    span.className = 'active-word-highlight';
                } else {
                    span.className = 'clickable-word';
                }
            });
        }

        // --- Quiz Logic ---
        function initQuiz() {
            quizStep = 'start';
            q1Status = null;
            q2Pool = ['Berlin', 'ist', 'wunderschÃ¶n', 'sehr'];
            q2Answer = [];
            q3Status = null;
            q4Status = null;
        }

        function startQuiz() {
            quizStep = 'q1';
            const story = stories.find(s => s.id === currentStoryId);
            window.renderStoryView(story);
        }

        function answerQ1(isTrue) {
            const isCorrect = !isTrue; 
            q1Status = isCorrect ? 'correct' : 'wrong';
            window.renderStoryView(stories.find(s => s.id === currentStoryId));
            if (isCorrect) setTimeout(() => { quizStep = 'q2'; window.renderStoryView(stories.find(s => s.id === currentStoryId)); }, 1000);
        }

        function toggleQ2Word(word) {
            const poolIndex = q2Pool.indexOf(word);
            if (poolIndex > -1) {
                q2Pool.splice(poolIndex, 1);
                q2Answer.push(word);
            } else {
                const answerIndex = q2Answer.indexOf(word);
                if (answerIndex > -1) {
                    q2Answer.splice(answerIndex, 1);
                    q2Pool.push(word);
                }
            }
            window.renderStoryView(stories.find(s => s.id === currentStoryId));
        }

        function checkQ2() {
            const currentStr = q2Answer.join(' ');
            if (currentStr === 'Berlin ist wunderschÃ¶n') quizStep = 'q3';
            else alert('Try again! Order: Subject + Verb + Adjective');
            window.renderStoryView(stories.find(s => s.id === currentStoryId));
        }
        
        function answerQ3(answer) {
            const isCorrect = answer === 'Eine Stadt';
            q3Status = isCorrect ? 'correct' : 'wrong';
            window.renderStoryView(stories.find(s => s.id === currentStoryId));
            if (isCorrect) setTimeout(() => { quizStep = 'q4'; window.renderStoryView(stories.find(s => s.id === currentStoryId)); }, 1000);
        }
        
        function answerQ4(answer) {
            const isCorrect = answer === 'wohnt';
            q4Status = isCorrect ? 'correct' : 'wrong';
            window.renderStoryView(stories.find(s => s.id === currentStoryId));
            if (isCorrect) setTimeout(() => { quizStep = 'end'; window.renderStoryView(stories.find(s => s.id === currentStoryId)); }, 1000);
        }

        function renderStoryView(story) {
            const container = document.getElementById('main-content');
            if(!container) return;
            container.scrollTop = 0;
            if(!story) return;
            
            const heroImage = story.image || "https://images.unsplash.com/photo-1599946347371-68eb71b16afc?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80";
            
            let headerContent = '';
            if (currentSubTab === 'read' && lookupState) {
                headerContent = `
                    <div class="pointer-events-auto animate-fade-in">
                        <h2 id="lookup-word" class="text-4xl font-bold text-white mb-2 tracking-tight">${lookupState.word}</h2>
                        <div class="flex items-baseline justify-center gap-2 mb-1">
                            <p id="lookup-translation" class="text-xl text-gray-200 font-medium">${lookupState.translation}</p>
                            <button class="text-white/80 hover:text-white ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.468 8.282a3.975 3.975 0 010 5.656m-3-2.828a1.975 1.975 0 010 2.828M5.25 12h8.5" /></svg>
                            </button>
                            <!-- AI Analyze Button -->
                            <button onclick="window.analyzeWord('${lookupState.word.replace(/'/g, "\\'")}')" class="bg-white/20 hover:bg-white/30 text-white text-xs font-bold px-2 py-1 rounded ml-2 backdrop-blur-sm transition-colors">
                                âœ¨ Analyze
                            </button>
                        </div>
                        <p id="lookup-extra" class="text-sm italic text-gray-400 font-medium bg-black/30 px-3 py-1 rounded-full backdrop-blur-sm mt-2 inline-block">${lookupState.extra}</p>
                    </div>`;
            } else {
                let title = story.title;
                let subtext = "Tap a word to translate";
                if (currentSubTab === 'quiz') { title = "Quiz Time"; subtext = "Test your comprehension"; } 
                else if (currentSubTab === 'keywords') { title = "Key Vocabulary"; subtext = "5 Words from this story"; } 
                else if (currentSubTab === 'grammar') { title = "Grammar Focus"; subtext = "Learn the rules"; }
                
                headerContent = `
                    <div class="pointer-events-auto text-center animate-fade-in" id="default-header-content">
                        <h2 class="text-3xl font-bold text-white mb-2 tracking-tight drop-shadow-md">${title}</h2>
                        <p class="text-gray-200 font-medium drop-shadow">${subtext}</p>
                    </div>`;
            }

            let headerHTML = `
                <div class="relative w-full h-44 bg-gray-900 shrink-0 transition-all duration-300" id="story-header-image">
                    <img src="${heroImage}" class="w-full h-full object-cover opacity-40 absolute inset-0" alt="Berlin Streets">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/30 to-black/80"></div>
                    <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-20 pt-4">
                        <button onclick="window.closeStory()" class="text-white hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-white/10 backdrop-blur-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                        </button>
                    </div>
                    <div class="absolute inset-0 flex flex-col justify-center items-center text-center z-10 pt-6 px-4 pointer-events-none" id="header-content-wrapper">
                        ${headerContent}
                    </div>
                </div>
                <div class="flex bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 w-full overflow-x-auto no-scrollbar shrink-0">
                    <button onclick="window.setSubTab('read')" class="flex-1 py-3 px-2 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${currentSubTab === 'read' ? 'border-brand-600 text-brand-700 bg-brand-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">Story</button>
                    <button onclick="window.setSubTab('quiz')" class="flex-1 py-3 px-2 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${currentSubTab === 'quiz' ? 'border-brand-600 text-brand-700 bg-brand-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">Quiz</button>
                    <button onclick="window.setSubTab('keywords')" class="flex-1 py-3 px-2 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${currentSubTab === 'keywords' ? 'border-brand-600 text-brand-700 bg-brand-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">Keywords</button>
                    <button onclick="window.setSubTab('grammar')" class="flex-1 py-3 px-2 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${currentSubTab === 'grammar' ? 'border-brand-600 text-brand-700 bg-brand-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">Grammar</button>
                </div>`;

            let content = '';
            if (currentSubTab === 'read') {
                const sentenceData = [
                    { de: "Der Sommer in Berlin ist wunderschÃ¶n.", en: "Summer in Berlin is beautiful." },
                    { de: "Die Menschen sitzen drauÃŸen in den CafÃ©s und genieÃŸen die Sonne.", en: "People sit outside in cafes and enjoy the sun." },
                    { de: "Gestern war ich im Park und habe ein Buch gelesen.", en: "Yesterday I was in the park and read a book." },
                    { de: "Es war sehr entspannend.", en: "It was very relaxing." },
                    { de: "Dort habe ich auch meinen Freund getroffen.", en: "There I also met my friend." },
                    { de: "Wir haben Eis gegessen.", en: "We ate ice cream." },
                    { de: "Das Wetter war perfekt.", en: "The weather was perfect." },
                    { de: "Ich liebe diese Stadt.", en: "I love this city." }
                ];
                
                const displaySentences = (story.id > 100 && story.content && story.content.german) 
                    ? [{de: story.content.german, en: story.content.english}] 
                    : sentenceData;

                const createClickableSentence = (sentence) => {
                    if (!sentence) return '';
                    return sentence.split(' ').map((word) => {
                        const cleanWord = word.replace(/[.,!?]/g, '');
                        const isHighlighted = cleanWord === activeWordId;
                        const safeWord = cleanWord.replace(/'/g, "\\'");
                        return `<span onclick="window.lookupWord('${safeWord}', this)" class="${isHighlighted ? "active-word-highlight" : "clickable-word"}">${word}</span>`;
                    }).join(' ');
                };

                const wrapperClass = isEnglishVisible ? "block mb-6" : "inline mr-1";
                const englishClass = isEnglishVisible ? "block mt-1 text-brand-600 font-sans text-sm font-medium animate-fade-in" : "hidden";

                content = `
                    <div class="flex items-center justify-between px-6 py-3 border-b border-gray-100 bg-white z-20 shrink-0">
                        <div class="flex items-center gap-5">
                            <span class="bg-brand-600 text-white text-xs font-bold px-2.5 py-1 rounded shadow-sm">${story.level}</span>
                            <div class="h-5 w-px bg-gray-200"></div>
                            <button onclick="window.toggleTranslation()" class="${isEnglishVisible ? 'text-brand-600 bg-brand-50 border border-brand-100' : 'text-gray-400 hover:text-gray-600 border border-transparent'} transition-colors p-1.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" /></svg></button>
                            <button onclick="window.cycleFontSize()" class="text-gray-400 hover:text-gray-600 transition-colors"><span class="font-serif ${fontSizes[fontSizeIndex]} font-medium">Aa</span></button>
                            <button id="like-btn" onclick="window.toggleLike()" class="transition-all duration-200 ${isStoryLiked ? 'text-pink-500' : 'text-gray-400 hover:text-pink-500'}">${isStoryLiked ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>`}</button>
                            <button onclick="window.toggleStoryLearned(${story.id})" class="transition-all duration-200 ${story.isLearned ? 'text-green-500' : 'text-gray-400 hover:text-green-500'}">
                                ${story.isLearned ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'}
                            </button>
                        </div>
                        <span class="text-xs text-gray-400 font-medium">Today</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar relative" id="story-scroll-container">
                        <div class="px-6 py-6 pb-32">
                            <h1 class="text-2xl font-bold text-gray-900 mb-6 font-serif tracking-tight leading-tight">${story.title}</h1>
                            <div class="story-text ${fontSizes[fontSizeIndex]} leading-relaxed font-serif text-gray-800" id="story-text-content">
                                ${displaySentences.map(s => `<span class="${wrapperClass}"><span class="inline">${createClickableSentence(s.de)}</span><span class="${englishClass}">${s.en}</span></span>`).join('')}
                            </div>
                            
                            <!-- Mark as learned button at the end -->
                            <div class="mt-12 mb-8 flex justify-center">
                                <button onclick="window.toggleStoryLearned(${story.id})" class="flex items-center gap-2 px-6 py-3 rounded-full font-bold shadow-md transition-all active:scale-95 ${story.isLearned ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-800 text-white hover:bg-gray-700'}">
                                    ${story.isLearned ? 
                                        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg> Learned' 
                                        : 
                                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg> Mark as learned'
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floating Bottom Action Bar -->
                    <div class="absolute bottom-6 left-0 right-0 z-30 flex justify-center pointer-events-none">
                        <div class="bg-white/90 backdrop-blur-md shadow-floating border border-gray-200/50 rounded-full px-5 py-1.5 flex items-center gap-6 pointer-events-auto transform transition-transform hover:scale-105">
                             <button class="flex items-center gap-2 text-gray-600 hover:text-brand-600 transition-colors group">
                                <div class="w-6 h-6 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center shadow-sm group-hover:bg-brand-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>
                                </div>
                                <span class="text-[9px] font-bold">Story</span>
                             </button>
                             <div class="w-px h-5 bg-gray-200"></div>
                             <button onclick="window.explainGrammar()" class="flex items-center gap-2 text-brand-700 hover:text-brand-800 transition-colors">
                                <span class="text-base">âœ¨</span>
                                <span class="text-[9px] font-bold">Explain</span>
                             </button>
                             <div class="w-px h-5 bg-gray-200"></div>
                             <button class="flex items-center gap-2 text-gray-600 hover:text-brand-600 transition-colors group">
                                <span class="text-[9px] font-bold">Sentence</span>
                                <div class="w-6 h-6 rounded-full bg-gray-50 text-gray-600 flex items-center justify-center shadow-sm group-hover:bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>
                                </div>
                             </button>
                        </div>
                    </div>`;
            } else if (currentSubTab === 'grammar') { content = `<div class="bg-white min-h-[500px] animate-fade-in flex-1 overflow-y-auto no-scrollbar">${renderGrammarView()}</div>`;
            } else if (currentSubTab === 'quiz') { 
                const story = stories.find(s => s.id === currentStoryId);
                const hasQuiz = false; 
                
                if (hasQuiz) {
                    content = `<div class="flex-1 overflow-y-auto no-scrollbar">${renderQuizView()}</div>`;
                } else {
                     content = `
                        <div class="flex-1 flex flex-col items-center justify-center p-8 animate-fade-in">
                            <div class="w-20 h-20 bg-brand-50 rounded-full flex items-center justify-center mb-6 text-brand-600"><span class="text-4xl">âœ¨</span></div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">AI Quiz Generator</h2>
                            <p class="text-gray-500 text-center mb-6 text-sm">Generate a unique quiz based on this story to test your comprehension.</p>
                            <button onclick="window.generateAIQuiz()" class="bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform active:scale-95 flex items-center gap-2"><span>Generate Quiz</span></button>
                        </div>
                     `;
                }
            } else if (currentSubTab === 'keywords') { content = `<div class="flex-1 overflow-y-auto no-scrollbar">${renderKeywordsView()}</div>`; }

            container.innerHTML = `<div class="flex flex-col h-full">${headerHTML}${content}</div>`;
        }
        
        function generateAIQuiz() {
             const story = stories.find(s => s.id === currentStoryId);
             if (!story) return;
             window.openAIModal(`<div class="flex flex-col items-center justify-center py-8"><div class="loader mb-4"></div><p class="text-gray-600 font-medium">Generating quiz questions...</p></div>`);
            setTimeout(() => {
                window.closeAIModal();
                const container = document.getElementById('main-content');
                const contentArea = container.querySelector('.flex-1');
                if(contentArea) contentArea.innerHTML = window.renderQuizView();
            }, 2000);
        }

        async function analyzeWord(word) {
             window.openAIModal(`<div class="flex flex-col items-center justify-center py-8"><div class="loader mb-4"></div><p class="text-gray-600 font-medium">Analyzing "${word}"...</p></div>`);
            const prompt = `Analyze the German word "${word}". Provide: 1. Part of speech & Gender (if noun) 2. Meaning in context 3. A short example sentence. Output as simple HTML.`;
            try {
                // Mock API Call - replace with real API call if key present
                const result = `
                    <p><strong>Meaning:</strong> A fake mock definition for ${word}.</p>
                    <p><strong>Example:</strong> Das ist ein Beispiel.</p>
                `;
                window.openAIModal(`<h3 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2"><span class="text-brand-600">âœ¨</span> Word Analysis</h3><h2 class="text-2xl font-serif text-brand-700 mb-4">${word}</h2><div class="text-gray-700 text-sm leading-relaxed space-y-2">${result}</div><button onclick="window.closeAIModal()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg mt-6">Close</button>`);
            } catch (err) {
                 window.closeAIModal();
                 alert("Analysis failed.");
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            const navStories = document.getElementById('nav-stories');
            const navVocab = document.getElementById('nav-vocabulary');
            const navFlashcards = document.getElementById('nav-flashcards');
            
            navStories.className = "flex flex-col items-center justify-center w-1/3 h-full text-gray-400 hover:text-gray-600 relative group";
            navVocab.className = "flex flex-col items-center justify-center w-1/3 h-full text-gray-400 hover:text-gray-600 relative group";
            navFlashcards.className = "flex flex-col items-center justify-center w-1/3 h-full text-gray-400 hover:text-gray-600 relative group";

            if (tab === 'stories') {
                navStories.className = "flex flex-col items-center justify-center w-1/3 h-full text-brand-600 relative group";
                renderStoriesTab();
            } else if (tab === 'vocabulary') {
                navVocab.className = "flex flex-col items-center justify-center w-1/3 h-full text-brand-600 relative group";
                renderVocabularyTab();
            } else {
                navFlashcards.className = "flex flex-col items-center justify-center w-1/3 h-full text-brand-600 relative group";
                isReviewDashboard = true; 
                renderFlashcardsTab();
            }
        }

        function openSubscriptionPage() {
            const subscriptionView = document.getElementById('subscription-view');
            if (subscriptionView) {
                subscriptionView.classList.remove('translate-y-full');
            }
        }

        function closeSubscriptionPage() {
            const subscriptionView = document.getElementById('subscription-view');
            if (subscriptionView) {
                subscriptionView.classList.add('translate-y-full');
            }
        }

        function handleSubscribe() {
            const btn = event.currentTarget;
            const originalText = btn.innerText;
            btn.innerHTML = `<div class="loader border-white border-t-transparent w-5 h-5 mx-auto"></div>`;
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                window.closeSubscriptionPage();
                
                // Show success modal
                window.openAIModal(`
                    <div class="flex flex-col items-center justify-center py-6 text-center">
                        <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Welcome to Premium!</h3>
                        <p class="text-gray-500 text-sm mb-6">You now have unlimited access to all features.</p>
                        <button onclick="window.closeAIModal()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg">Start Learning</button>
                    </div>
                `);
            }, 1500);
        }

        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            const panel = document.getElementById('profile-panel');
            if (modal && panel) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    panel.classList.remove('translate-y-full');
                }, 10);
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            const panel = document.getElementById('profile-panel');
            if (modal && panel) {
                modal.classList.add('opacity-0');
                panel.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        function openSettingsPage() {
            const view = document.getElementById('settings-view');
            if (view) view.classList.remove('translate-x-full');
        }

        function closeSettingsPage() {
            const view = document.getElementById('settings-view');
            if (view) view.classList.add('translate-x-full');
        }
        
        function switchSettingsTab(tab) {
            ['general', 'stories', 'review'].forEach(t => {
                const btn = document.getElementById(`tab-settings-${t}`);
                const content = document.getElementById(`settings-content-${t}`);
                if(t === tab) {
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-brand-600 transition-all";
                    content.classList.remove('hidden');
                } else {
                    btn.className = "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:bg-white/50 transition-all";
                    content.classList.add('hidden');
                }
            });
        }

        function openAIModal(contentHTML) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');
            if (modal && content) {
                content.innerHTML = contentHTML;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);
            }
        }

        function closeAIModal() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');
            if (modal && content) {
                modal.classList.add('opacity-0');
                content.classList.add('scale-95');
                content.classList.remove('scale-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // Placeholders for views/functions not provided in snippet but referenced
        function openCreateStoryModal() { console.log('Feature coming soon'); }
        function generateStory() { console.log('Feature coming soon'); }
        function explainGrammar() { window.openAIModal('<div class="p-4 text-center">Grammar explanation feature coming soon!</div><button onclick="window.closeAIModal()" class="w-full mt-4 p-2 bg-gray-200 rounded">Close</button>'); }
        function selectLevel() { console.log('Level selected'); }
        
        function renderKeywordsView() {
            return `<div class="p-6 pb-32">
                <h3 class="text-xl font-bold mb-4">Keywords</h3>
                <div class="space-y-3">
                    ${keywordsData.map(k => `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-lg">${k.word}</h4>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${k.type}</span>
                            </div>
                            <p class="text-sm text-gray-600 italic mb-2">${k.english}</p>
                            <p class="text-xs text-gray-400 border-l-2 border-brand-200 pl-2">${k.context}</p>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        function renderGrammarView() {
            return `<div class="p-6 pb-32">
                <h3 class="text-xl font-bold mb-4">Grammar Focus</h3>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-blue-800 mb-4">
                    <h4 class="font-bold mb-2">Present Tense</h4>
                    <p class="text-sm">German verbs change endings based on the subject.</p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                    <p class="font-bold mb-2">Example: Lieben (to love)</p>
                    <ul class="text-sm space-y-1 text-gray-600">
                        <li>Ich liebe (I love)</li>
                        <li>Du liebst (You love)</li>
                        <li>Er/Sie/Es liebt (He/She/It loves)</li>
                    </ul>
                </div>
            </div>`;
        }

        function renderQuizView() {
            return `<div class="p-6 pb-32 text-center">
                <h3 class="text-xl font-bold mb-6">Quick Check</h3>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-4">
                    <p class="font-medium text-lg mb-4">Is Berlin beautiful in summer?</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="alert('Correct!')" class="py-3 bg-green-50 text-green-600 font-bold rounded-xl border border-green-100">Yes</button>
                        <button onclick="alert('Try again')" class="py-3 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100">No</button>
                    </div>
                </div>
            </div>`;
        }

        function openStreakPage() {
            // Check if we need to render heatmap
            const container = document.getElementById('heatmap-container');
            if(container && container.innerHTML.trim() === '') {
                renderHeatmap(container);
            }
            const view = document.getElementById('streak-view');
            if (view) view.classList.remove('translate-x-full');
        }

        function closeStreakPage() {
            const view = document.getElementById('streak-view');
            if (view) view.classList.add('translate-x-full');
        }

        function renderHeatmap(container) {
            // Generate a grid of weeks (columns) and days (rows)
            // 7 rows (Mon-Sun), ~20 columns to simulate recent history
            const rows = 7;
            const cols = 20; 
            let html = '';
            
            for (let i = 0; i < cols; i++) {
                // Determine if this column should look busy or sparse
                // Just random data for visual simulation
                for (let j = 0; j < rows; j++) {
                    const intensity = Math.random();
                    let colorClass = 'bg-gray-100'; // Default empty
                    
                    // Simulate patterns
                    if (intensity > 0.8) colorClass = 'bg-brand-600';
                    else if (intensity > 0.6) colorClass = 'bg-brand-400';
                    else if (intensity > 0.3) colorClass = 'bg-brand-200';
                    
                    html += `<div class="w-3 h-3 rounded-sm ${colorClass}"></div>`;
                }
            }
            
            container.innerHTML = html;
            // Update grid template columns based on generated cols
            container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        }


        // --- Window Binding (Explicit and Safe) ---
        window.openStory = openStory;
        window.closeStory = closeStory;
        window.switchTab = switchTab;
        window.openCreateStoryModal = openCreateStoryModal;
        window.generateStory = generateStory;
        window.explainGrammar = explainGrammar;
        window.toggleTranslation = toggleTranslation;
        window.cycleFontSize = cycleFontSize;
        window.toggleLike = toggleLike;
        window.setSubTab = setSubTab;
        window.lookupWord = lookupWord;
        window.startQuiz = startQuiz;
        window.answerQ1 = answerQ1;
        window.answerQ3 = answerQ3;
        window.answerQ4 = answerQ4;
        window.checkQ2 = checkQ2;
        window.toggleQ2Word = toggleQ2Word;
        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.openSettingsPage = openSettingsPage;
        window.closeSettingsPage = closeSettingsPage;
        window.switchSettingsTab = switchSettingsTab;
        window.selectLevel = selectLevel;
        window.closeAIModal = closeAIModal;
        window.openCreateStoryModal = openCreateStoryModal; 
        window.startSession = startSession;
        window.nextCard = nextCard;
        window.flipCard = flipCard;
        window.playAudio = playAudio;
        window.renderStoriesTab = renderStoriesTab;
        window.renderFlashcardsTab = renderFlashcardsTab;
        window.renderStoryView = renderStoryView;
        window.renderVocabularyTab = renderVocabularyTab;
        window.generateAIQuiz = generateAIQuiz;
        window.analyzeWord = analyzeWord;
        window.renderReviewDashboard = renderReviewDashboard;
        window.renderSessionView = renderSessionView;
        window.renderFlashcardControls = renderFlashcardControls;
        window.renderKeywordsView = renderKeywordsView;
        window.renderGrammarView = renderGrammarView;
        window.renderQuizView = renderQuizView;
        window.initSwipeGestures = initSwipeGestures;
        window.openSubscriptionPage = openSubscriptionPage;
        window.closeSubscriptionPage = closeSubscriptionPage;
        window.handleSubscribe = handleSubscribe;
        window.openAIModal = openAIModal; 
        window.openStreakPage = openStreakPage;
        window.closeStreakPage = closeStreakPage;
        window.toggleStoryLearned = toggleStoryLearned;
        window.toggleHideLearned = toggleHideLearned;
        window.renderHeatmap = renderHeatmap;

        // --- Init ---
        // Ensure everything is ready before calling render
        if (document.readyState === "loading") {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => window.renderStoriesTab(), 100);
            });
        } else {
            // DOM already loaded
            setTimeout(() => {
                window.renderStoriesTab();
            }, 50); 
        }
        
    </script>
</body>
</html>